# Multi-Cloud Secrets Management Example
# Demonstrates retrieving secrets from multiple cloud providers in a single workflow

name: "multi_cloud_secrets_workflow"
description: "Retrieve application secrets from multiple cloud providers and configure application"

steps:
  # Get database credentials from AWS Secrets Manager
  - name: "get_aws_database_creds"
    plugin: "aws_secrets_manager"
    parameters:
      secret_name: "production/database/credentials"
      region_name: "us-east-1"
      action: "read"

  # Get API keys from Azure Key Vault
  - name: "get_azure_api_keys"
    plugin: "azure_key_vault"
    parameters:
      vault_url: "https://prod-vault.vault.azure.net/"
      secret_name: "api-keys"
      action: "read"
      tenant_id: "${AZURE_TENANT_ID}"
      client_id: "${AZURE_CLIENT_ID}"
      client_secret: "${AZURE_CLIENT_SECRET}"

  # Get service account from Google Secret Manager
  - name: "get_gcp_service_account"
    plugin: "google_secret_manager"
    parameters:
      project_id: "my-gcp-project"
      secret_id: "service-account-json"
      action: "read"

  # Get infrastructure tokens from HashiCorp Vault
  - name: "get_vault_infra_tokens"
    plugin: "hashicorp_vault"
    parameters:
      vault_url: "https://vault.example.com:8200"
      secret_path: "infrastructure/tokens"
      action: "read"
      role_id: "${VAULT_ROLE_ID}"
      secret_id: "${VAULT_SECRET_ID}"

  # Write consolidated configuration file
  - name: "write_application_config"
    plugin: "write_file_content"
    parameters:
      file_path: "/app/config/application.yaml"
      content: |
        database:
          host: "${steps.get_aws_database_creds.output.value.host}"
          username: "${steps.get_aws_database_creds.output.value.username}"
          password: "${steps.get_aws_database_creds.output.value.password}"

        api:
          aws_key: "${steps.get_azure_api_keys.output.secret_value.aws_key}"
          azure_key: "${steps.get_azure_api_keys.output.secret_value.azure_key}"

        gcp:
          service_account: "${steps.get_gcp_service_account.output.secret_value}"

        vault:
          infra_token: "${steps.get_vault_infra_tokens.output.data.token}"
      mode: "overwrite"
      create_dirs: true

  # Verify configuration by reading it back
  - name: "verify_configuration"
    plugin: "read_file_content"
    parameters:
      file_path: "/app/config/application.yaml"

  # Send notification that configuration is ready
  - name: "send_config_ready_notification"
    plugin: "send_email"
    parameters:
      smtp_server: "smtp.gmail.com"
      smtp_port: 587
      from_address: "automation@company.com"
      to_addresses:
        - "devops@company.com"
        - "security@company.com"
      subject: "Multi-Cloud Configuration Updated"
      body: |
        The application configuration has been successfully updated with secrets from:
        - AWS Secrets Manager
        - Azure Key Vault
        - Google Secret Manager
        - HashiCorp Vault

        Configuration file: /app/config/application.yaml
        Update time: $(date)
      body_html: |
        <h1>Multi-Cloud Configuration Updated</h1>
        <p>The application configuration has been successfully updated with secrets from:</p>
        <ul>
          <li>AWS Secrets Manager</li>
          <li>Azure Key Vault</li>
          <li>Google Secret Manager</li>
          <li>HashiCorp Vault</li>
        </ul>
        <p><strong>Configuration file:</strong> /app/config/application.yaml</p>
        <p><strong>Update time:</strong> $(date)</p>
      username: "${EMAIL_USERNAME}"
      password: "${EMAIL_PASSWORD}"
